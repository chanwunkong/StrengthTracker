<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>力量成長曲線</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-bottom: 20px;
        }

        main {
            display: flex;
            gap: 40px;
        }

        .controls,
        .user-data {
            flex: 1;
        }

        .controls label,
        .user-data label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .controls input[type="range"],
        .controls input[type="number"],
        .controls select,
        .user-data input[type="number"] {
            width: 100%;
            padding: 5px;
            margin-bottom: 15px;
        }

        .chart-container {
            margin-top: 30px;
        }

        #chart {
            width: 100%;
            height: 600px;
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
        }
    </style>
</head>

<body>

    <h2 id="title">力量成長曲線</h2>

    <header>
        <div>
            <label for="languageSelect">Language / 語言:</label>
            <select id="languageSelect" onchange="updateChart()">
                <option value="zh">中文</option>
                <option value="en">English</option>
            </select>
        </div>
        <div>
            <label for="unitSelect">單位 / Unit:</label>
            <select id="unitSelect" onchange="updateChart()">
                <option value="kg">公斤 (kg)</option>
                <option value="lb">磅 (lb)</option>
            </select>
        </div>
    </header>

    <main>
        <div class="controls">
            <label for="genderSelect">選擇性別:</label>
            <select id="genderSelect" onchange="setDefaultWeight(); updateChart()">
                <option value="male">男性</option>
                <option value="female">女性</option>
            </select>

            <label for="movementSelect">選擇動作:</label>
            <select id="movementSelect" onchange="updateChart()">
                <option value="Press">肩推 (Press)</option>
                <option value="Bench Press">臥推 (Bench Press)</option>
                <option value="Squat">深蹲 (Squat)</option>
                <option value="Deadlift">硬舉 (Deadlift)</option>
                <option value="Power Clean">抓舉 (Power Clean)</option>
            </select>

            <label for="weightRange">選擇體重:</label>
            <input type="range" id="weightRange" min="40" max="120" value="70" step="1"
                oninput="syncWeightInput(this.value)">
            <span id="weightDisplay">70 kg</span>

            <label for="xMaxRange">X 軸最大值 (月):</label>
            <input type="range" id="xMaxRange" min="12" max="120" value="60" step="1" oninput="updateChart()">
            <span id="xMaxDisplay">60 月</span>

            <label for="yMaxRange">Y 軸最大值:</label>
            <input type="range" id="yMaxRange" min="50" max="500" value="200" step="10" oninput="updateChart()">
            <span id="yMaxDisplay">200 kg</span>
        </div>

        <div class="user-data">
            <h3>輸入您的當前數據</h3>

            <label for="userWeight">您的體重:</label>
            <input type="number" id="userWeight" value="70" step="1" oninput="syncWeightSlider(this.value)">
            <span id="userWeightUnit">kg</span>

            <label for="userRM">您的 RM (次數):</label>
            <input type="number" id="userRM" value="5" step="1" oninput="updateChart()">

            <label for="userStrength">您該 RM 的重量:</label>
            <input type="number" id="userStrength" step="1" oninput="updateChart()">
            <span id="userStrengthUnit">kg</span>

            <h4 id="oneRMDisplay"></h4>
        </div>
    </main>

    <div class="chart-container">
        <div id="chart"></div>
    </div>

    <script>
        let language = 'zh';
        let unit = 'kg';

        const movementParams = {
            "male": {
                "Press": { a: 0.143081, s: -0.006382, t_b: 1.175420, p: -10.000000, q: 0.000139, r: 0.523168 },
                "Bench Press": { a: 0.313917, s: -0.002640, t_b: 0.483858, p: -0.542333, q: 0.008190, r: 0.885181 },
                "Squat": { a: 0.542238, s: -0.004639, t_b: 0.839241, p: 0.094006, q: 1.000000, r: 0.207660 },
                "Deadlift": { a: 0.616152, s: -0.004511, t_b: 0.793862, p: -10.000000, q: 0.000214, r: 0.927825 },
                "Power Clean": { a: 0.272927, s: -0.006954, t_b: 1.241554, p: -0.831159, q: 0.002697, r: 0.608000 }
            },
            "female": {
                "Press": { a: 1.060079656, s: -0.00000479555, t_b: 0.016407532, p: -9.999999936, q: 0.0000283981, r: 0.344401136 },
                "Bench Press": { a: 1.156197656, s: -0.0000694985, t_b: 0.022878292, p: -9.999999992, q: 0.000181857, r: 0.591675884 },
                "Squat": { a: 0.518626596, s: -0.000598282, t_b: 0.193108691, p: -9.999999999, q: 0.000101625, r: 0.53494326 },
                "Deadlift": { a: 1.107697795, s: -0.000438779, t_b: 0.096978515, p: -9.999999985, q: 0.000191939, r: 0.685331933 },
                "Power Clean": { a: 0.372718555, s: -0.000882204, t_b: 0.208095481, p: -9.999999796, q: 0.000073921, r: 0.384703321 }
            }
        };

        function calculateAbsoluteStrength(t, w, params) {
            const ratio = params.a * Math.log((params.s * w + params.t_b) * t + 1) + (params.p * Math.log(params.q * w + 1) + params.r);
            return ratio * w;
        }

        function calculateOneRM(weight, reps) {
            return weight / (1.0278 - 0.0278 * reps);
        }

        function setDefaultWeight() {
            const gender = document.getElementById('genderSelect').value;
            const weightRange = document.getElementById('weightRange');
            const userWeight = document.getElementById('userWeight');

            if (gender === 'male') {
                weightRange.value = 70;
                userWeight.value = 70;
            } else {
                weightRange.value = 55;
                userWeight.value = 55;
            }
            updateChart();
        }

        function syncWeightInput(value) {
            document.getElementById('userWeight').value = parseInt(value);
            updateChart();
        }

        function syncWeightSlider(value) {
            if (value < 40) value = 40;
            if (value > 120) value = 120;
            document.getElementById('weightRange').value = parseInt(value);
            updateChart();
        }

        function updateChart() {
            language = document.getElementById('languageSelect').value;
            unit = document.getElementById('unitSelect').value;

            const gender = document.getElementById('genderSelect').value;
            const movement = document.getElementById('movementSelect').value;
            const params = movementParams[gender][movement];

            let weight = parseInt(document.getElementById('weightRange').value);
            let userWeight = parseInt(document.getElementById('userWeight').value);
            let weightDisplay = document.getElementById('weightDisplay');

            let xMax = parseInt(document.getElementById('xMaxRange').value);
            let yMax = parseInt(document.getElementById('yMaxRange').value);

            let userRM = parseInt(document.getElementById('userRM').value);
            let userStrengthInput = parseFloat(document.getElementById('userStrength').value);

            if (unit === 'lb') {
                weightDisplay.innerText = Math.round(weight * 2.20462) + ' lb';
                document.getElementById('userWeightUnit').innerText = 'lb';
                document.getElementById('userStrengthUnit').innerText = 'lb';
            } else {
                weightDisplay.innerText = weight + ' kg';
                document.getElementById('userWeightUnit').innerText = 'kg';
                document.getElementById('userStrengthUnit').innerText = 'kg';
            }

            document.getElementById('xMaxDisplay').innerText = xMax + (language === 'zh' ? ' 月' : ' months');
            document.getElementById('yMaxDisplay').innerText = yMax + ' ' + unit;

            let xData = [];
            let yData = [];

            for (let t = 0; t <= xMax; t++) {
                let strength = calculateAbsoluteStrength(t, weight, params);
                if (unit === 'lb') strength *= 2.20462;
                xData.push(t);
                yData.push(Math.round(strength));
            }

            const trace = {
                x: xData,
                y: yData,
                type: 'scatter',
                mode: 'lines+markers',
                name: getMovementName(movement)
            };

            let userTrace = null;

            if (!isNaN(userStrengthInput) && userStrengthInput > 0 && !isNaN(userRM) && userRM > 0) {
                let weightInKg = unit === 'lb' ? userStrengthInput / 2.20462 : userStrengthInput;
                let estimatedOneRM = calculateOneRM(weightInKg, userRM);
                let displayOneRM = Math.round(unit === 'lb' ? estimatedOneRM * 2.20462 : estimatedOneRM);

                document.getElementById('oneRMDisplay').innerText = (language === 'zh' ? '預估 1RM：' : 'Estimated 1RM: ') + displayOneRM + ' ' + unit;

                let closestIndex = 0;
                let minDiff = Infinity;

                for (let i = 0; i < yData.length; i++) {
                    let diff = Math.abs(yData[i] - displayOneRM);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }

                userTrace = {
                    x: [xData[closestIndex]],
                    y: [yData[closestIndex]],
                    mode: 'markers+text',
                    marker: { size: 12, color: 'blue' },
                    text: ['1RM'],
                    textposition: 'top center',
                    name: language === 'zh' ? '您的 1RM 位置' : 'Your 1RM'
                };
            } else {
                document.getElementById('oneRMDisplay').innerText = '';
            }

            const layout = {
                title: getChartTitle(weight, movement, gender),
                xaxis: { title: language === 'zh' ? '訓練時間（月）' : 'Training Time (Months)', range: [0, xMax] },
                yaxis: { title: language === 'zh' ? '絕對力量 (' + unit + ')' : 'Absolute Strength (' + unit + ')', range: [0, yMax] },
                shapes: [
                    { type: 'line', x0: 6, y0: 0, x1: 6, y1: yMax, line: { color: 'red', dash: 'dot' } },
                    { type: 'line', x0: 12, y0: 0, x1: 12, y1: yMax, line: { color: 'red', dash: 'dot' } },
                    { type: 'line', x0: 24, y0: 0, x1: 24, y1: yMax, line: { color: 'red', dash: 'dot' } },
                    { type: 'line', x0: 48, y0: 0, x1: 48, y1: yMax, line: { color: 'red', dash: 'dot' } }
                ],
                annotations: [
                    { x: 6, y: 0, text: language === 'zh' ? '新手' : 'Beginner', showarrow: false, font: { color: 'red' }, yshift: -20 },
                    { x: 12, y: 0, text: language === 'zh' ? '中級' : 'Novice', showarrow: false, font: { color: 'red' }, yshift: -20 },
                    { x: 24, y: 0, text: language === 'zh' ? '高級' : 'Intermediate', showarrow: false, font: { color: 'red' }, yshift: -20 },
                    { x: 48, y: 0, text: language === 'zh' ? '精英' : 'Elite', showarrow: false, font: { color: 'red' }, yshift: -20 }
                ]
            };

            if (userTrace) {
                Plotly.newPlot('chart', [trace, userTrace], layout);
            } else {
                Plotly.newPlot('chart', [trace], layout);
            }
        }

        function getChartTitle(weight, movement, gender) {
            let genderText = (language === 'zh') ? (gender === 'male' ? '男性' : '女性') : (gender === 'male' ? 'Male' : 'Female');
            let movementName = getMovementName(movement);
            let weightDisplay = unit === 'lb' ? Math.round(weight * 2.20462) + ' lb' : weight + ' kg';
            return language === 'zh' ?
                '體重 ' + weightDisplay + ' 的 ' + movementName + ' 力量成長曲線 (' + genderText + ')' :
                movementName + ' Strength Progression (' + genderText + ', ' + weightDisplay + ')';
        }

        function getMovementName(movement) {
            const names = {
                'Press': language === 'zh' ? '肩推 (Press)' : 'Press',
                'Bench Press': language === 'zh' ? '臥推 (Bench Press)' : 'Bench Press',
                'Squat': language === 'zh' ? '深蹲 (Squat)' : 'Squat',
                'Deadlift': language === 'zh' ? '硬舉 (Deadlift)' : 'Deadlift',
                'Power Clean': language === 'zh' ? '抓舉 (Power Clean)' : 'Power Clean'
            };
            return names[movement];
        }

        setDefaultWeight();
        updateChart();
    </script>

</body>

</html>